// ==================== PH·∫¶N C·∫§U H√åNH ====================

const CONFIG = {
    siteTitle: "TMCLibrary",
    footerText: "¬© 2025-2028 TMCLibrary | Th∆∞ vi·ªán m√£ ngu·ªìn m·ªü cho c·ªông ƒë·ªìng",
    baseUrl: "https://cybertmc.github.io/TMCLibrary",
    
    // üî• GOOGLE APPS SCRIPT URL - THAY B·∫∞NG URL C·ª¶A B·∫†N
    googleScriptUrl: "https://script.google.com/macros/s/AKfycbxyU5pU2kA-VCHz53R6nq4RgaPJw5EC9DgngiGGz3wPvnxtLyu19r9ueKydOSnzkBYMyg/exec",
    
    // Link nh√∫ng YouTube CLEAN - kh√¥ng qu·∫£ng c√°o, kh√¥ng ti√™u ƒë·ªÅ
    youtubeEmbedUrl: "https://www.youtube-nocookie.com/embed/9vntypeV5QU?si=nUgUGR0c_aZbxH5H&autoplay=1&mute=1&controls=0&disablekb=1&modestbranding=1&rel=0&showinfo=0&iv_load_policy=3&playsinline=1&loop=1&playlist=9vntypeV5QU",
    
    // Li√™n k·∫øt m·∫°ng x√£ h·ªôi
    socialLinks: [
        { name: "Facebook", url: "https://www.facebook.com/100053167816454", icon: "fab fa-facebook-f", class: "facebook" },
        { name: "Instagram", url: "https://www.instagram.com/tran_chuyenhiii/?igsh=MWltcmM3b2ljbWJ3aQ%3D%3D&utm_source=qr#", icon: "fab fa-instagram", class: "instagram" },
        { name: "TikTok", url: "https://www.tiktok.com/@tranchinnn", icon: "fab fa-tiktok", class: "tiktok" }
    ],
    
    // Danh s√°ch code snippets
    codes: [
        {
            id: "1",
            title: "H·∫πn h√≤ nh∆∞ng kh√¥ng y√™u",
            desc: "Code hi·ªÉn th·ªã l·ªùi b√†i h√°t v·ªõi hi·ªáu ·ª©ng m√†u s·∫Øc ƒë·∫πp m·∫Øt trong Python",
            lang: "python",
            pinned: true,
            tiktokVideo: "https://www.tiktok.com/embed/v2/7574464770758216967",
            links: [
                {name: "Link code", url: "https://ideone.com/V4JZi6"},
            ]
        },
        // ... c√°c code kh√°c gi·ªØ nguy√™n
    ]
};

// ==================== K·∫æT TH√öC PH·∫¶N C·∫§U H√åNH ====================

// Kh·ªüi t·∫°o bi·∫øn l∆∞u tr·ªØ
let globalViewCounts = {};

// ==================== H√ÄM X·ª¨ L√ù L∆Ø·ª¢T XEM ====================

// üî• H√†m g·ª≠i l∆∞·ª£t xem l√™n Google Sheets (FIXED)
async function incrementViewCount(codeId) {
    try {
        // TƒÉng l∆∞·ª£t xem c·ª•c b·ªô tr∆∞·ªõc ƒë·ªÉ hi·ªÉn th·ªã ngay
        globalViewCounts[codeId] = (globalViewCounts[codeId] || 0) + 1;
        
        // L∆∞u v√†o localStorage ƒë·ªÉ backup
        localStorage.setItem('tmcLocalViewCounts', JSON.stringify(globalViewCounts));
        
        // G·ª≠i request l√™n server (kh√¥ng c·∫ßn ch·ªù k·∫øt qu·∫£)
        fetch(CONFIG.googleScriptUrl, {
            method: 'POST',
            mode: 'no-cors', // Quan tr·ªçng: Google Apps Script c·∫ßn no-cors
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'increment',
                code_id: codeId,
                timestamp: new Date().toISOString()
            })
        }).catch(error => {
            console.log('Kh√¥ng th·ªÉ g·ª≠i l∆∞·ª£t xem l√™n server, s·ª≠ d·ª•ng b·∫£n local');
        });
        
        return globalViewCounts[codeId];
    } catch (error) {
        console.error('L·ªói khi tƒÉng l∆∞·ª£t xem:', error);
        return globalViewCounts[codeId] || 0;
    }
}

// üî• H√†m l·∫•y t·∫•t c·∫£ l∆∞·ª£t xem t·ª´ server (FIXED)
async function loadViewCounts() {
    try {
        loadingIndicator.style.display = 'block';
        
        // Th·ª≠ l·∫•y t·ª´ server
        const response = await fetch(`${CONFIG.googleScriptUrl}?action=get_all&t=${Date.now()}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result && result.success) {
            globalViewCounts = result.viewCounts || {};
            console.log('ƒê√£ t·∫£i l∆∞·ª£t xem t·ª´ server:', globalViewCounts);
        }
    } catch (error) {
        console.log('Kh√¥ng th·ªÉ t·∫£i l∆∞·ª£t xem t·ª´ server, s·ª≠ d·ª•ng b·∫£n local:', error.message);
        // S·ª≠ d·ª•ng localStorage n·∫øu c√≥
        loadFromLocalStorage();
    } finally {
        // ƒê·∫£m b·∫£o m·ªói code ƒë·ªÅu c√≥ l∆∞·ª£t xem
        CONFIG.codes.forEach(code => {
            if (!globalViewCounts[code.id]) {
                globalViewCounts[code.id] = 0;
            }
        });
        
        loadingIndicator.style.display = 'none';
        filterAndSort();
    }
}

// üî• H√†m t·∫£i t·ª´ localStorage
function loadFromLocalStorage() {
    const stored = localStorage.getItem('tmcLocalViewCounts');
    if (stored) {
        try {
            globalViewCounts = JSON.parse(stored);
            console.log('ƒê√£ t·∫£i l∆∞·ª£t xem t·ª´ localStorage:', globalViewCounts);
        } catch (e) {
            globalViewCounts = {};
        }
    }
}

// üî• L·∫•y l∆∞·ª£t xem cho m·ªôt code
function getViewCount(codeId) {
    return globalViewCounts[codeId] || 0;
}

// ==================== H√ÄM M·ªû MODAL (FIXED) ====================

async function openDetailModal(code) {
    currentModalCode = code;
    
    modal.style.display = 'block';
    modalLoading.style.display = 'flex';
    modalContent.style.display = 'none';
    
    try {
        // TƒÉng l∆∞·ª£t xem ngay l·∫≠p t·ª©c
        const currentViews = await incrementViewCount(code.id);
        
        // C·∫≠p nh·∫≠t UI
        modalTitle.textContent = code.title;
        modalDesc.textContent = code.desc;
        modalViewCount.textContent = currentViews;
        
        // C·∫≠p nh·∫≠t badge ng√¥n ng·ªØ
        modalBadges.innerHTML = '';
        const langBadge = document.createElement('span');
        langBadge.className = 'lang-badge';
        langBadge.textContent = code.lang;
        modalBadges.appendChild(langBadge);
        
        if (code.pinned === true) {
            const pinBadge = document.createElement('span');
            pinBadge.className = 'pin-badge';
            pinBadge.innerHTML = '<i class="fas fa-thumbtack"></i> ƒê√£ ghim';
            modalBadges.appendChild(pinBadge);
        }
        
        // C·∫≠p nh·∫≠t video TikTok n·∫øu c√≥
        if (code.tiktokVideo) {
            tiktokVideoContainer.style.display = 'block';
            tiktokVideo.src = code.tiktokVideo;
        } else {
            tiktokVideoContainer.style.display = 'none';
        }
        
        // C·∫≠p nh·∫≠t link chia s·∫ª
        const shareLink = `${CONFIG.baseUrl}?id=${code.id}`;
        shareUrl.value = shareLink;
        
        const encodedUrl = encodeURIComponent(shareLink);
        const encodedTitle = encodeURIComponent(code.title);
        
        facebookShare.href = `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`;
        twitterShare.href = `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}`;
        linkedinShare.href = `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`;
        telegramShare.href = `https://t.me/share/url?url=${encodedUrl}&text=${encodedTitle}`;
        
        // C·∫≠p nh·∫≠t link code
        modalLinks.innerHTML = '';
        code.links.forEach(link => {
            const btn = document.createElement('button');
            btn.className = 'ideone-btn';
            btn.innerHTML = `<i class="fas fa-external-link-alt"></i> ${link.name}`;
            btn.onclick = (e) => {
                e.stopPropagation();
                window.open(link.url, '_blank');
            };
            modalLinks.appendChild(btn);
        });

        if (code.tiktokVideo) {
            const tiktokBtn = document.createElement('button');
            tiktokBtn.className = 'tiktok-btn';
            tiktokBtn.innerHTML = `<i class="fab fa-tiktok"></i> Xem Video Demo`;
            tiktokBtn.onclick = (e) => {
                e.stopPropagation();
                tiktokVideoContainer.scrollIntoView({ behavior: 'smooth' });
            };
            modalLinks.appendChild(tiktokBtn);
        }
        
        // Hi·ªÉn th·ªã n·ªôi dung modal
        modalLoading.style.display = 'none';
        modalContent.style.display = 'block';
        
    } catch (error) {
        console.error('L·ªói khi m·ªü modal:', error);
        modalLoading.style.display = 'none';
        modalContent.style.display = 'block';
        modalDesc.textContent = 'ƒê√£ tƒÉng l∆∞·ª£t xem!';
    }
}

// ==================== H√ÄM RENDER CARD (FIXED) ====================

function renderCards(list) {
    cardsContainer.innerHTML = "";

    if (list.length === 0) {
        const message = currentFilter === 'pinned' 
            ? "Kh√¥ng c√≥ code n√†o ƒë∆∞·ª£c ghim. Th√™m thu·ªôc t√≠nh 'pinned: true' v√†o code trong danh s√°ch CONFIG."
            : "Th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c ƒëi·ªÅu ch·ªânh b·ªô l·ªçc";
        
        cardsContainer.innerHTML = `
            <div class="empty-state">
                <i class="${currentFilter === 'pinned' ? 'fas fa-thumbtack' : 'fas fa-code'}"></i>
                <h3>${currentFilter === 'pinned' ? 'Ch∆∞a c√≥ code n√†o ƒë∆∞·ª£c ghim' : 'Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£'}</h3>
                <p>${message}</p>
            </div>
        `;
        return;
    }

    list.forEach(item => {
        const viewCount = getViewCount(item.id);
        const isPinned = item.pinned === true;
        
        const card = document.createElement("div");
        card.className = `card ${isPinned ? 'pinned' : ''}`;
        
        // S·ª≠ d·ª•ng event delegation ƒë·ªÉ tr√°nh memory leak
        card.addEventListener('click', () => openDetailModal(item));

        card.innerHTML = `
            <div class="card-header">
                <h3 class="card-title">${item.title}</h3>
                <div class="card-badges">
                    ${isPinned ? '<span class="pin-badge"><i class="fas fa-thumbtack"></i> ƒê√£ ghim</span>' : ''}
                    <span class="lang-badge">${item.lang}</span>
                </div>
            </div>
            <p class="card-desc">${item.desc}</p>
            <div class="card-stats">
                <span class="view-count"><i class="fas fa-eye"></i> ${viewCount} l∆∞·ª£t xem</span>
            </div>
            <div class="code-links">
                ${item.links.map(link => 
                    `<button class="ideone-btn" data-url="${link.url}">
                        <i class="fas fa-external-link-alt"></i> ${link.name}
                    </button>`
                ).join('')}
                ${item.tiktokVideo ? 
                    `<button class="tiktok-btn">
                        <i class="fab fa-tiktok"></i> Xem Video
                    </button>` : ''
                }
            </div>
        `;

        // X·ª≠ l√Ω s·ª± ki·ªán click cho c√°c button
        card.querySelectorAll('.ideone-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                window.open(btn.getAttribute('data-url'), '_blank');
            });
        });

        card.querySelectorAll('.tiktok-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                openDetailModal(item);
            });
        });

        cardsContainer.appendChild(card);
    });
}

// ==================== KH·ªûI T·∫†O ====================

// Kh·ªüi ch·∫°y khi trang load xong
document.addEventListener('DOMContentLoaded', () => {
    updatePinnedCount();
    loadViewCounts();
    createParticles();
    
    // Load t·ª´ localStorage ngay l·∫≠p t·ª©c ƒë·ªÉ c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã
    loadFromLocalStorage();
    filterAndSort();
});
